<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TheOneFile_Verse</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    :root{
      --bg:#0d0d0d;
      --bg-alt:#1a1a1a;
      --surface:#242424;
      --border:#333;
      --text:#e8e8e8;
      --text-soft:#999;
      --accent:#c9a227;
      --accent-hover:#d4b23a;
      --steel:#71717a;
      --steel-light:#a1a1aa;
    }

    [data-theme="light"]{
      --bg:#f5f3ef;
      --bg-alt:#eae7e0;
      --surface:#fff;
      --border:#d4d0c8;
      --text:#1a1a1a;
      --text-soft:#666;
      --accent:#996b1f;
      --accent-hover:#7a5518;
      --steel:#52525b;
      --steel-light:#71717a;
    }

    body{
      font-family:system-ui,-apple-system,sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .theme-toggle{
      position:fixed;
      top:20px;
      right:20px;
      background:var(--surface);
      border:1px solid var(--border);
      color:var(--text);
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-size:14px;
    }
    .theme-toggle:hover{background:var(--bg-alt)}

    .container{
      text-align:center;
      max-width:400px;
      width:100%;
    }

    h1{
      font-size:28px;
      font-weight:700;
      margin-bottom:8px;
      color:var(--text);
      letter-spacing:-0.5px;
    }

    .tagline{
      color:var(--text-soft);
      font-size:15px;
      margin-bottom:40px;
    }

    .actions{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .btn{
      padding:14px 24px;
      font-size:15px;
      font-weight:500;
      border:none;
      border-radius:8px;
      cursor:pointer;
      width:100%;
    }

    .btn-primary{
      background:var(--accent);
      color:#fff;
    }
    .btn-primary:hover{background:var(--accent-hover)}

    .btn-secondary{
      background:var(--surface);
      color:var(--text);
      border:1px solid var(--border);
    }
    .btn-secondary:hover{background:var(--bg-alt)}

    .modal-overlay{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:100;
    }
    .modal-overlay.active{display:flex}

    .modal{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:12px;
      width:100%;
      max-width:420px;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 20px;
      border-bottom:1px solid var(--border);
    }
    .modal-header h2{font-size:18px;font-weight:600}

    .modal-close{
      background:none;
      border:none;
      color:var(--text-soft);
      font-size:22px;
      cursor:pointer;
      line-height:1;
      padding:0;
    }
    .modal-close:hover{color:var(--text)}

    .modal-body{
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .form-group{display:flex;flex-direction:column;gap:6px}
    .form-group label{font-size:13px;font-weight:500;color:var(--text-soft)}

    .form-group input,.form-group select{
      padding:10px 12px;
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:6px;
      color:var(--text);
      font-size:14px;
    }
    .form-group input:focus,.form-group select:focus{
      outline:none;
      border-color:var(--accent);
    }
    .form-group input::placeholder{color:var(--text-soft)}

    .file-drop{
      border:1px dashed var(--border);
      border-radius:6px;
      padding:24px;
      text-align:center;
      cursor:pointer;
    }
    .file-drop:hover{border-color:var(--steel-light)}
    .file-drop-text{font-size:14px;color:var(--text-soft)}
    .file-drop-formats{font-size:12px;color:var(--text-soft);margin-top:4px;opacity:0.7}

    .file-selected{
      display:none;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      background:var(--bg);
      border-radius:6px;
      font-size:14px;
    }
    .file-selected.active{display:flex}
    .file-selected-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .file-selected-clear{background:none;border:none;color:var(--steel);cursor:pointer;font-size:16px}

    .modal-footer{
      padding:16px 20px;
      border-top:1px solid var(--border);
    }
    .modal-footer .btn{width:100%}

    .error-text{
      color:#c53030;
      font-size:13px;
      display:none;
    }
    .error-text.active{display:block}

    .footer{
      position:fixed;
      bottom:20px;
      font-size:12px;
      color:var(--text-soft);
    }
    .footer a{color:var(--steel-light);text-decoration:none}
    .footer a:hover{color:var(--accent)}

    .user-menu{
      position:fixed;
      top:20px;
      left:20px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .user-avatar{
      width:36px;
      height:36px;
      border-radius:50%;
      background:var(--accent);
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:600;
      font-size:14px;
    }
    .user-name{font-size:14px;color:var(--text)}
    .user-btn{
      background:var(--surface);
      border:1px solid var(--border);
      color:var(--text);
      padding:6px 12px;
      border-radius:6px;
      cursor:pointer;
      font-size:13px;
    }
    .user-btn:hover{background:var(--bg-alt)}

    .auth-buttons{
      display:flex;
      gap:8px;
      position:fixed;
      top:20px;
      left:20px;
    }
    .auth-buttons .btn{padding:8px 16px;font-size:13px;width:auto}

    .oidc-providers{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:16px;
    }
    .oidc-btn{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 16px;
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:8px;
      color:var(--text);
      cursor:pointer;
      font-size:14px;
      width:100%;
    }
    .oidc-btn:hover{border-color:var(--accent)}
    .oidc-btn img{width:20px;height:20px}

    .divider{
      display:flex;
      align-items:center;
      gap:12px;
      margin:16px 0;
      color:var(--text-soft);
      font-size:13px;
    }
    .divider::before,.divider::after{
      content:'';
      flex:1;
      height:1px;
      background:var(--border);
    }

    .tabs{
      display:flex;
      border-bottom:1px solid var(--border);
      margin-bottom:16px;
    }
    .tab{
      flex:1;
      padding:12px;
      background:none;
      border:none;
      color:var(--text-soft);
      cursor:pointer;
      font-size:14px;
    }
    .tab.active{
      color:var(--accent);
      border-bottom:2px solid var(--accent);
      margin-bottom:-1px;
    }

    .guest-mode-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding:12px;
      background:var(--bg);
      border-radius:6px;
      margin-top:12px;
    }
    .guest-mode-toggle input{width:18px;height:18px}
    .guest-mode-toggle label{font-size:13px;color:var(--text-soft)}

    @media(max-width:480px){
      h1{font-size:24px}
      .tagline{font-size:14px;margin-bottom:32px}
      .auth-buttons,.user-menu{
        top:12px;
        left:12px;
        gap:8px;
      }
      .auth-buttons .btn{padding:6px 10px;font-size:12px}
      .user-avatar{width:32px;height:32px;font-size:12px}
      .user-name{font-size:12px}
      .user-btn{padding:4px 8px;font-size:11px}
    }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()">
    <span id="theme-icon">☀</span>
  </button>

  <div class="user-menu" id="user-menu" style="display:none">
    <div class="user-avatar" id="user-avatar"></div>
    <span class="user-name" id="user-name"></span>
    <button class="user-btn" onclick="logout()">Logout</button>
  </div>

  <div class="auth-buttons" id="auth-buttons" style="display:none">
    <button class="btn btn-secondary" onclick="openModal('login')">Sign In</button>
    <button class="btn btn-primary" onclick="openModal('register')">Register</button>
  </div>

  <div class="container">
    <h1>TheOneFile_Verse</h1>
    <p class="tagline">It turns out there CAN be more than one.</p>

    <div class="actions">
      <button class="btn btn-primary" onclick="openModal('create')">Create Room</button>
      <button class="btn btn-secondary" onclick="openModal('join')">Join Room</button>
    </div>
  </div>

  <div class="footer">
    <a href="/admin">Admin</a>
  </div>

  <div class="modal-overlay" id="create-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>Create Room</h2>
        <button class="modal-close" onclick="closeModal('create')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Password (optional)</label>
          <input type="password" id="create-password" placeholder="Leave empty for open access">
        </div>
        <div class="form-group">
          <label>Room Expiration</label>
          <select id="create-destruct">
            <option value="3600000">1 hour after last activity</option>
            <option value="21600000">6 hours after last activity</option>
            <option value="86400000" selected>24 hours after last activity</option>
            <option value="604800000">7 days after last activity</option>
            <option value="empty">When everyone leaves</option>
            <option value="never">Never</option>
          </select>
        </div>
        <div class="form-group">
          <label>Import file (optional)</label>
          <div class="file-drop" id="create-file-drop">
            <div class="file-drop-text">Drop file or click to browse</div>
            <div class="file-drop-formats">.html .json .csv .md</div>
          </div>
          <input type="file" id="create-file-input" accept=".html,.json,.csv,.md,.markdown,.txt" hidden>
          <div class="file-selected" id="create-file-selected">
            <span class="file-selected-name" id="create-file-name"></span>
            <button class="file-selected-clear" onclick="clearFile()">&times;</button>
          </div>
        </div>
        <div class="guest-mode-toggle" id="guest-toggle-container" style="display:none">
          <input type="checkbox" id="create-allow-guests" checked>
          <label for="create-allow-guests">Allow unregistered users (guests) to join</label>
        </div>
        <div class="error-text" id="create-error"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="createRoom()">Create</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="join-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>Join Room</h2>
        <button class="modal-close" onclick="closeModal('join')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Room ID or URL</label>
          <input type="text" id="join-room-id" placeholder="Paste room ID or link">
        </div>
        <div class="form-group" id="join-password-group" style="display:none">
          <label>Password</label>
          <input type="password" id="join-password" placeholder="Enter room password">
        </div>
        <div class="error-text" id="join-error"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="joinRoom()">Join</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="login-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>Sign In</h2>
        <button class="modal-close" onclick="closeModal('login')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="oidc-providers" id="login-oidc-providers"></div>
        <div class="divider" id="login-divider" style="display:none">or</div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" placeholder="you@example.com">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" placeholder="Your password">
        </div>
        <div class="error-text" id="login-error"></div>
        <div style="display:flex;justify-content:space-between;margin-top:8px">
          <a href="#" onclick="openModal('forgot');closeModal('login');return false" style="font-size:13px;color:var(--accent)">Forgot password?</a>
          <a href="#" onclick="openModal('magic');closeModal('login');return false" style="font-size:13px;color:var(--accent)">Email me a link</a>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="loginWithPassword()">Sign In</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="register-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>Create Account</h2>
        <button class="modal-close" onclick="closeModal('register')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="oidc-providers" id="register-oidc-providers"></div>
        <div class="divider" id="register-divider" style="display:none">or</div>
        <div class="form-group">
          <label>Display Name</label>
          <input type="text" id="register-name" placeholder="How should we call you?">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="register-email" placeholder="you@example.com">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="register-password" placeholder="At least 8 characters">
        </div>
        <div class="error-text" id="register-error"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="registerUser()">Create Account</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="forgot-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>Reset Password</h2>
        <button class="modal-close" onclick="closeModal('forgot')">&times;</button>
      </div>
      <div class="modal-body">
        <p style="font-size:14px;color:var(--text-soft);margin-bottom:16px">Enter your email and we'll send you a link to reset your password.</p>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="forgot-email" placeholder="you@example.com">
        </div>
        <div class="error-text" id="forgot-error"></div>
        <div class="error-text" id="forgot-success" style="color:#22c55e"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="requestPasswordReset()">Send Reset Link</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="magic-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>Passwordless Login</h2>
        <button class="modal-close" onclick="closeModal('magic')">&times;</button>
      </div>
      <div class="modal-body">
        <p style="font-size:14px;color:var(--text-soft);margin-bottom:16px">We'll email you a magic link that logs you in instantly.</p>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="magic-email" placeholder="you@example.com">
        </div>
        <div class="error-text" id="magic-error"></div>
        <div class="error-text" id="magic-success" style="color:#22c55e"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="requestMagicLink()">Send Magic Link</button>
      </div>
    </div>
  </div>

  <script>
    let forcedTheme = null;

    function getTheme() {
      if (forcedTheme && forcedTheme !== 'user') return forcedTheme;
      return localStorage.getItem('theme') || 'dark';
    }
    function setTheme(theme) {
      if (!forcedTheme || forcedTheme === 'user') {
        localStorage.setItem('theme', theme);
      }
      document.documentElement.setAttribute('data-theme', theme);
      document.getElementById('theme-icon').textContent = theme === 'dark' ? '☀' : '☾';
    }
    function toggleTheme() {
      if (forcedTheme && forcedTheme !== 'user') return;
      setTheme(getTheme() === 'dark' ? 'light' : 'dark');
    }
    function updateThemeToggleVisibility() {
      const btn = document.querySelector('.theme-toggle');
      if (forcedTheme && forcedTheme !== 'user') {
        btn.style.display = 'none';
      } else {
        btn.style.display = 'block';
      }
    }

    setTheme(getTheme());

    fetch('/api/theme').then(r => r.json()).then(data => {
      if (data.forcedTheme && data.forcedTheme !== 'user') {
        forcedTheme = data.forcedTheme;
        setTheme(forcedTheme);
      }
      updateThemeToggleVisibility();
    }).catch(() => { updateThemeToggleVisibility(); });

    let selectedFile = null;
    let selectedFileContent = null;

    function generateUUID() {
      if (crypto.randomUUID) return crypto.randomUUID();
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
      });
    }

    function getOrCreateUserId(roomId) {
      const key = 'collab-user-' + roomId;
      let id = localStorage.getItem(key);
      if (!id) { id = generateUUID(); localStorage.setItem(key, id); }
      return id;
    }

    function openModal(type) { document.getElementById(type + '-modal').classList.add('active'); }
    function closeModal(type) {
      document.getElementById(type + '-modal').classList.remove('active');
      document.getElementById(type + '-error').classList.remove('active');
    }

    function showError(type, msg) {
      const el = document.getElementById(type + '-error');
      el.textContent = msg;
      el.classList.add('active');
    }

    const fileDrop = document.getElementById('create-file-drop');
    const fileInput = document.getElementById('create-file-input');

    fileDrop.addEventListener('click', () => fileInput.click());
    fileDrop.addEventListener('dragover', e => { e.preventDefault(); });
    fileDrop.addEventListener('drop', e => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

    const MAX_FILE_SIZE_MB = 10;
    const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

    async function handleFile(file) {
      if (!file) return;

      if (file.size > MAX_FILE_SIZE_BYTES) {
        showError('create', `File too large. Maximum size is ${MAX_FILE_SIZE_MB}MB`);
        return;
      }

      const ext = file.name.split('.').pop().toLowerCase();
      if (!['html', 'json', 'csv', 'md', 'markdown', 'txt'].includes(ext)) {
        showError('create', 'Invalid file type');
        return;
      }
      selectedFile = file;
      selectedFileContent = await file.text();
      document.getElementById('create-file-drop').style.display = 'none';
      document.getElementById('create-file-selected').classList.add('active');
      document.getElementById('create-file-name').textContent = file.name + ` (${(file.size / 1024).toFixed(1)}KB)`;
    }

    function clearFile() {
      selectedFile = null;
      selectedFileContent = null;
      document.getElementById('create-file-drop').style.display = 'block';
      document.getElementById('create-file-selected').classList.remove('active');
      fileInput.value = '';
    }

    function parseTopologyFile(content, filename) {
      const ext = filename.split('.').pop().toLowerCase();
      if (ext === 'json') { try { return JSON.parse(content); } catch { return null; } }
      if (ext === 'html') {
        const match = content.match(/<script[^>]*id="topology-state"[^>]*>([\s\S]*?)<\/script>/i);
        if (match) { try { return JSON.parse(match[1]); } catch {} }
        return null;
      }
      if (ext === 'csv') {
        const m = content.match(/#THEONEFILE_CONFIG:(.+)/);
        if (m) { try { return JSON.parse(m[1]); } catch {} }
        return null;
      }
      if (['md', 'markdown', 'txt'].includes(ext)) {
        const m = content.match(/<!--THEONEFILE_CONFIG\s*([\s\S]*?)\s*THEONEFILE_CONFIG-->/);
        if (m) { try { return JSON.parse(m[1].trim()); } catch {} }
        return null;
      }
      return null;
    }

    async function createRoom() {
      const password = document.getElementById('create-password').value;
      const destructVal = document.getElementById('create-destruct').value;
      const allowGuestsCheckbox = document.getElementById('create-allow-guests');
      const allowGuests = allowGuestsCheckbox ? allowGuestsCheckbox.checked : true;

      let destructMode = 'time', destructMs = parseInt(destructVal);
      if (destructVal === 'empty') { destructMode = 'empty'; destructMs = 0; }
      else if (destructVal === 'never') { destructMode = 'never'; destructMs = 0; }

      let topology = null;
      if (selectedFileContent) topology = parseTopologyFile(selectedFileContent, selectedFile.name);

      const tempId = generateUUID();
      const creatorId = getOrCreateUserId(tempId);

      try {
        const res = await fetch('/api/room', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: password || null, destructMode, destructValue: destructMs, topology, creatorId, allowGuests })
        });
        const data = await res.json();
        if (data.error) { showError('create', data.error); return; }
        localStorage.setItem('collab-user-' + data.id, creatorId);
        window.location.href = data.url;
      } catch { showError('create', 'Failed to create room'); }
    }

    const joinInput = document.getElementById('join-room-id');
    let checking = false;

    joinInput.addEventListener('input', async () => {
      let id = joinInput.value.trim();
      if (id.includes('/s/')) { id = id.split('/s/')[1].split('?')[0]; joinInput.value = id; }
      if (id.length < 36 || checking) return;
      checking = true;
      try {
        const res = await fetch('/api/room/' + id + '/exists');
        const data = await res.json();
        document.getElementById('join-password-group').style.display = data.hasPassword ? 'block' : 'none';
        if (!data.exists) showError('join', 'Room not found');
        else document.getElementById('join-error').classList.remove('active');
      } catch {}
      checking = false;
    });

    async function joinRoom() {
      let id = document.getElementById('join-room-id').value.trim();
      if (id.includes('/s/')) id = id.split('/s/')[1].split('?')[0];
      const password = document.getElementById('join-password').value;
      if (!id) { showError('join', 'Enter a room ID'); return; }

      try {
        const existsRes = await fetch('/api/room/' + id + '/exists');
        const exists = await existsRes.json();
        if (!exists.exists) { showError('join', 'Room not found'); return; }

        if (exists.hasPassword) {
          const verifyRes = await fetch('/api/room/' + id + '/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
          });
          if (!(await verifyRes.json()).valid) { showError('join', 'Invalid password'); return; }
        }

        if (password) sessionStorage.setItem('room-' + id + '-pwd', password);
        window.location.href = '/s/' + id;
      } catch { showError('join', 'Failed to join room'); }
    }

    document.querySelectorAll('.modal-overlay').forEach(el => {
      el.addEventListener('click', e => { if (e.target === el) el.classList.remove('active'); });
    });
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
    });

    let currentUser = null;
    let authSettings = null;
    let oidcProviders = [];

    async function loadAuthState() {
      try {
        const settingsRes = await fetch('/api/auth/settings', { credentials: 'include' });
        const settingsData = await settingsRes.json();
        authSettings = settingsData.settings;
        oidcProviders = settingsData.providers || [];
        const userRes = await fetch('/api/auth/me', { credentials: 'include' });
        const userData = await userRes.json();
        currentUser = userData.user;
        updateAuthUI();
      } catch (e) {
        console.error('Failed to load auth state:', e);
      }
    }

    function updateAuthUI() {
      const userMenu = document.getElementById('user-menu');
      const authButtons = document.getElementById('auth-buttons');
      const guestToggle = document.getElementById('guest-toggle-container');

      if (currentUser) {
        userMenu.style.display = 'flex';
        authButtons.style.display = 'none';
        document.getElementById('user-avatar').textContent = (currentUser.displayName || currentUser.email || 'U')[0].toUpperCase();
        document.getElementById('user-name').textContent = currentUser.displayName || currentUser.email?.split('@')[0] || 'User';
      } else if (authSettings) {
        userMenu.style.display = 'none';
        const hasOidc = oidcProviders && oidcProviders.length > 0;
        const registrationOpen = authSettings.authMode === 'open' || authSettings.authMode === 'registration';
        if (registrationOpen || hasOidc) {
          authButtons.style.display = 'flex';
        }
      }

      if (authSettings && authSettings.allowRoomCreatorGuestSetting) {
        if (currentUser || authSettings.allowGuestRoomCreation) {
          guestToggle.style.display = 'flex';
        } else {
          guestToggle.style.display = 'none';
        }
      } else {
        guestToggle.style.display = 'none';
      }
      renderOidcProviders('login-oidc-providers', 'login');
      renderOidcProviders('register-oidc-providers', 'register');
    }

    function renderOidcProviders(containerId, mode) {
      const container = document.getElementById(containerId);
      const divider = document.getElementById(mode + '-divider');
      container.innerHTML = '';

      if (oidcProviders.length === 0) {
        container.style.display = 'none';
        divider.style.display = 'none';
        return;
      }

      container.style.display = 'flex';
      divider.style.display = 'flex';

      oidcProviders.forEach(provider => {
        const btn = document.createElement('button');
        btn.className = 'oidc-btn';
        btn.innerHTML = provider.iconUrl
          ? `<img src="${provider.iconUrl}" alt="${provider.name}"> Continue with ${provider.name}`
          : `Continue with ${provider.name}`;
        btn.onclick = () => startOidcLogin(provider.id);
        container.appendChild(btn);
      });
    }

    async function startOidcLogin(providerId) {
      try {
        const res = await fetch('/api/auth/oidc/' + providerId);
        const data = await res.json();
        if (data.url) {
          window.location.href = data.url;
        } else {
          showError('login', data.error || 'Failed to start SSO');
        }
      } catch {
        showError('login', 'Failed to start SSO');
      }
    }

    async function loginWithPassword() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;

      if (!email || !password) {
        showError('login', 'Please enter email and password');
        return;
      }

      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (res.ok && data.success) {
          window.location.reload();
        } else {
          showError('login', data.error || 'Login failed');
        }
      } catch {
        showError('login', 'Connection error');
      }
    }

    async function registerUser() {
      const displayName = document.getElementById('register-name').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value;

      if (!email || !password) {
        showError('register', 'Please enter email and password');
        return;
      }
      if (password.length < 8) {
        showError('register', 'Password must be at least 8 characters');
        return;
      }
      if (!/[a-zA-Z]/.test(password)) {
        showError('register', 'Password must contain at least one letter');
        return;
      }
      if (!/[0-9!@#$%^&*()_+\-=\[\]{};\':"\\|,.<>\/?]/.test(password)) {
        showError('register', 'Password must contain a number or special character');
        return;
      }

      try {
        const res = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, password, displayName })
        });
        const data = await res.json();
        if (data.success) {
          if (data.requiresVerification) {
            closeModal('register');
            alert('Please check your email to verify your account.');
          } else {
            window.location.reload();
          }
        } else {
          showError('register', data.error || 'Registration failed');
        }
      } catch {
        showError('register', 'Connection error');
      }
    }

    async function requestPasswordReset() {
      const email = document.getElementById('forgot-email').value.trim();
      if (!email) {
        showError('forgot', 'Please enter your email');
        return;
      }

      try {
        const res = await fetch('/api/auth/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email })
        });
        const data = await res.json();
        document.getElementById('forgot-error').classList.remove('active');
        const success = document.getElementById('forgot-success');
        success.textContent = 'If an account exists, we\'ve sent a reset link.';
        success.classList.add('active');
      } catch {
        showError('forgot', 'Connection error');
      }
    }

    async function requestMagicLink() {
      const email = document.getElementById('magic-email').value.trim();
      if (!email) {
        showError('magic', 'Please enter your email');
        return;
      }

      try {
        const res = await fetch('/api/auth/magic-link', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email })
        });
        const data = await res.json();
        document.getElementById('magic-error').classList.remove('active');
        const success = document.getElementById('magic-success');
        success.textContent = 'If an account exists, we\'ve sent a magic link.';
        success.classList.add('active');
      } catch {
        showError('magic', 'Connection error');
      }
    }

    async function logout() {
      try {
        await fetch('/api/logout', { method: 'POST', credentials: 'include' });
        localStorage.removeItem('collab_token');
        localStorage.removeItem('user_token');
        currentUser = null;
        updateAuthUI();
        window.location.reload();
      } catch {
        window.location.reload();
      }
    }

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('auth_error')) {
      alert('Authentication error: ' + urlParams.get('auth_error'));
      history.replaceState({}, '', '/');
    }
    if (urlParams.get('verified') === 'true') {
      alert('Email verified! You can now sign in.');
      history.replaceState({}, '', '/');
    }
    if (urlParams.get('welcome') === 'true') {
      alert('Welcome! Your account has been created.');
      history.replaceState({}, '', '/');
    }

    loadAuthState();
  </script>
</body>
</html>
